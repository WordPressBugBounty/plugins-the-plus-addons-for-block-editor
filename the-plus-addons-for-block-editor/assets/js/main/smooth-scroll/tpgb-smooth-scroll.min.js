let lenisInstance=null,isInitialized=!1,retryCount=0,keyboardCleanup=null;const MAX_RETRIES=5,easings={linear:e=>e,"ease-out-cubic":e=>1-Math.pow(1-e,3),"ease-in-out":e=>e<.5?2*e*e:1-Math.pow(-2*e+2,3)/2,"ease-out-quart":e=>1-Math.pow(1-e,4),"ease-in-cubic":e=>e*e*e,"ease-out-quint":e=>1-Math.pow(1-e,5)};function initializeScrollSystem(){if(isInitialized)return;let e=document.querySelector(".tpgb-smooth-scroll");if(!e){retryCount<5&&(retryCount++,setTimeout(initializeScrollSystem,500));return}if("undefined"==typeof Lenis){retryCount<5?(retryCount++,setTimeout(initializeScrollSystem,500)):console.error("Lenis library not found. Please ensure the minified Lenis JS file is loaded.");return}initLenis()}function initLenis(){try{let e=getScrollConfig();lenisInstance=new Lenis({duration:e.animationTime?Math.max(.1,e.animationTime/5e3):1.2,easing:"custom"===e.easing?Function("t","return "+e.customEasing):easings[e.easing]||(e=>e),direction:"vertical",gestureDirection:"vertical",smooth:!0,smoothTouch:!0,wheelMultiplier:e.stepSize?Math.max(.1,e.stepSize/1e3):1,touchMultiplier:e.touchMultiplier||2,infinite:!0===e.infiniteScroll}),startAnimationLoop(),setupScrollEvents(e),setupKeyboardSupport(e),e.smoothNavigation&&setupSmoothScrollNavigation(lenisInstance,getScrollConfig()),setupResizeHandler(),isInitialized=!0,lenisInstance.emit()}catch(t){console.error("Lenis initialization error:",t),retryCount<5&&(retryCount++,lenisInstance=null,setTimeout(initLenis,1e3))}}function getScrollConfig(){let e=document.querySelector(".tpgb-smooth-scroll"),t={};if(e?.dataset.scrollattr)try{t=JSON.parse(e.dataset.scrollattr.replace(/&quot;/g,'"'))}catch(n){console.error("Error parsing scroll config:",n)}return t}function startAnimationLoop(){lenisInstance&&requestAnimationFrame(e);function e(t){lenisInstance&&!lenisInstance.destroyed&&(lenisInstance.raf(t),requestAnimationFrame(e))}}function setupKeyboardSupport(e){if(!lenisInstance)return;let t=e.stepSize||120,n=n=>{if(["INPUT","TEXTAREA","SELECT"].includes(n.target.tagName)||n.target.isContentEditable)return;let i={ArrowDown:t,ArrowUp:-t,PageDown:5*t,PageUp:-(5*t)," ":(n.shiftKey?-1:1)*t*5},o={Home:()=>performSmoothScroll(0,e.animationTime?e.animationTime/2500:1.5),End(){let t=Math.max(0,document.documentElement.scrollHeight-window.innerHeight);performSmoothScroll(t,e.animationTime?e.animationTime/2500:1.5)}};if(void 0!==i[n.key]||o[n.key]){if(n.preventDefault(),n.stopPropagation(),o[n.key])o[n.key]();else{let r=lenisInstance.scroll||0,l=Math.max(0,document.documentElement.scrollHeight-window.innerHeight),s=Math.max(0,Math.min(r+i[n.key],l));Math.abs(s-r)>=1&&performSmoothScroll(s,e.animationTime?e.animationTime/5e3:.8)}}};document.addEventListener("keydown",n,{capture:!0,passive:!1}),keyboardCleanup=()=>document.removeEventListener("keydown",n,{capture:!0})}function performSmoothScroll(e,t=1.2){if(!lenisInstance)return;let n=lenisInstance.scroll||0,i=Math.max(0,document.documentElement.scrollHeight-window.innerHeight),o=Math.max(0,Math.min(e,i));Math.abs(o-n)>=1&&lenisInstance.scrollTo(o,{duration:t})}function setupScrollEvents(e){lenisInstance&&lenisInstance.on("scroll",e=>{e.scroll;let t=document.querySelector(".tpgb-smooth-scroll");t?.parentElement&&Array.from(t.parentElement.children).forEach(e=>{if(e&&e!==t&&e.getBoundingClientRect().height>50){let n=e.getBoundingClientRect(),i=n.top<window.innerHeight&&n.bottom>0;e.classList.toggle("in-viewport",i)}})})}function setupResizeHandler(){let e;window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(()=>lenisInstance?.resize(),250)})}function destroyScrollSystem(){lenisInstance?.destroy(),lenisInstance=null,keyboardCleanup?.(),keyboardCleanup=null,isInitialized=!1,retryCount=0}window.scrollSystem={init:initializeScrollSystem,destroy:destroyScrollSystem,reinit(){destroyScrollSystem(),setTimeout(initializeScrollSystem,100)},getInstance:()=>lenisInstance};const initWhenReady=()=>{"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeScrollSystem):"interactive"===document.readyState?setTimeout(initializeScrollSystem,100):initializeScrollSystem()};initWhenReady();